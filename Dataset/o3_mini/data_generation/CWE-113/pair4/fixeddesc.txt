This version fixes the vulnerability by sanitizing the external input before it is included in the HTTP response header. By removing any carriage return or line feed characters, it prevents an attacker from injecting additional header lines. The remainder of the code still uses unsafe memory operations and concurrency constructs to preserve the realistic patterns seen in real-world code.