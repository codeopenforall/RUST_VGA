In this solution the file is opened immediately, and the metadata of the opened file (obtained via the file descriptor) is compared to the metadata fetched from the file path. By checking inode and device numbers, the code verifies that the actual file opened is the same as that originally expected. If a TOCTOU attack occurs (for instance, a symlink swap), the metadata will differ, and an error is raised. This comparison mitigates the race condition that leads to CWE-059.