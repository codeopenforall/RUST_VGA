In the corrected version the untrusted input is sanitized before header construction. The sanitize() function strips out carriage return and line feed characters, mitigating the risk of HTTP Response Splitting (CWE-113). The overall structure remains similar with unsafe global state and concurrent updates, preserving realistic coding patterns while ensuring that the final HTTP header cannot be manipulated via CRLF injection.