The corrected code fixes the CWE-022 vulnerability by using the canonicalize function to resolve the absolute path of both the base directory and the target file. After joining the base with the user-supplied input, it verifies that the canonicalized path starts with the allowed base directory. This check effectively blocks any directory traversal attempts. In addition, the unsafe conversion block has been replaced with a safe conversion that validates UTF-8 encoding.